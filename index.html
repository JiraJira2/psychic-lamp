<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marketplace Notifier</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 1rem; }
    h2 { color: #4ade80; }
    #log { max-height: 300px; overflow-y: auto; margin-top: 1rem; }
    .item { padding: 6px; border-bottom: 1px solid #333; }
    .price { color: #60a5fa; }
  </style>
</head>
<body>
  <h2>Marketplace Watcher</h2>
  <div id="log"></div>

  <script>
    let lastItems = {};

    // Listen for messages from game client
    window.addEventListener("message", (event) => {
      let data = event.data;

      // Assume marketplace data comes in as JSON string under key 'marketplace'
      if (data.marketplace) {
        try {
          let items = JSON.parse(data.marketplace);

          for (let id in items) {
            let item = items[id];
            if (!lastItems[id]) {
              // New item found
              notifyNewItem(item);
            }
          }
          lastItems = items;
        } catch (e) {
          console.error("Failed to parse marketplace JSON", e);
        }
      }
    });

    function notifyNewItem(item) {
      let log = document.getElementById("log");
      let div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<b>${item.name}</b> â€” <span class="price">$${item.price}</span>`;
      log.prepend(div);

      // Send notification to the game
      window.parent.postMessage({
        type: "notification",
        text: `New Item: ${item.name} ($${item.price})`
      }, "*");

      // Play sound effect
      window.parent.postMessage({
        type: "sfx",
        sfx: 6 // "CHALLENGE_UNLOCKED"
      }, "*");
    }

    // Request initial marketplace data when app loads
    window.parent.postMessage({ type: "getNamedData", keys: ["marketplace"] }, "*");
  </script>
</body>
</html>
